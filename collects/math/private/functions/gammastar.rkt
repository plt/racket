#lang typed/racket/base

(require "../../flonum.rkt"
         "../polynomial/chebyshev.rkt"
         "gamma.rkt")

(provide fllog-gamma* flgamma*)

(define sqrt2pi 2.5066282746310007)

(: fllog-gamma*-taylor-0 (Float -> Float))
(define (fllog-gamma*-taylor-0 x)
  (define logx (fllog x))
  (fl- (fl- ((make-flpolyfun
              (-9.1893853320467274178032973640561764e-1
               +4.2278433509846713939348790991759757e-1
               +8.2246703342411321823620758332301259e-1
               -4.0068563438653142846657938717048333e-1
               +2.7058080842778454787900092413529197e-1
               -2.0738555102867398526627309729140683e-1
               +1.6955717699740818995241965496515342e-1
               -1.4404989676884611811997107854997097e-1
               +1.2550966952474304242233565481358156e-1
               -1.1133426586956469049087252991471245e-1
               +1.000994575127818085337145958900319e-1
               -9.0954017145829042232609298411497267e-2
               +8.3353840546109004024886499837311639e-2
               -7.6932516411352191472827064348181339e-2
               +7.143294629536133605923275322179538e-2
               -6.6668705882420468032903448567376338e-2
               +6.2500955141213040741983285717977295e-2))
             x)
            (fl* x logx))
       (fl* 0.5 logx)))

(define fllog-gamma*-0.125-0.25
  (inline-chebyshev-flpoly-fun
   0.125 0.25
   (0.6964761849992798104792533311195762585223
    -0.08516483162570975785226534481504768613002
    0.01066662542452747741247056857644088891362
    -0.001396902862089484270005240949879717457069
    1.910661561666272288984193730794216323727e-4
    -2.708588072859068135037776329718361928106e-5
    3.9483677153067279598302854844587498153e-6
    -5.881146230174627336611812045782998575819e-7
    8.909125488736552624513376541095157798013e-8
    -1.367864391021821464939626341346059989603e-8
    2.123163865070339139718847835613854782087e-9
    -3.325286990436957837705607588371565104985e-10
    5.247434173180259026631475257604027890765e-11
    -8.333815756065495272299156518313025055591e-12
    1.330849158880619822172289522804245187776e-12
    -2.135438484053556257964930863540043443801e-13
    3.440817914910169038778927667677446001755e-14
    -5.564683113928318746127836380462285248256e-15
    9.029127098581633258048915894642998363966e-16
    -1.4693331053929753003754524998726987061e-16
    2.395777686986601776614531688810279353652e-17
    -3.815769934274306710558870550324426542293e-18)))

(define fllog-gamma*-0.25-0.5
  (inline-chebyshev-flpoly-fun
   0.25 0.5
   (0.4091651285864176659726065957820271765758
    -0.05835287794756156342446503949217004543644
    0.008214656347964040938797511942055861214951
    -0.001164042860654678048457298385642253841126
    1.674502860644061411642489178625356794213e-4
    -2.451045810725115411737715072742471571747e-5
    3.648128495071048247201066769994214227621e-6
    -5.511094592834696428596220834039494769185e-7
    8.432308913084841908773694100841860971225e-8
    -1.304234873089078995173306279292502656278e-8
    2.035856896446012985480479727661740755377e-9
    -3.202775790595535741866342654219822036621e-10
    5.072335398188079736752410336479846796946e-11
    -8.079695484584989865291471462248942587249e-12
    1.293488295449564021706182860084734965348e-12
    -2.079898150536204584704178003283808403881e-13
    3.357455800313407222400412514274580592639e-14
    -5.438507941507613185751027895825352856454e-15
    8.836732404739243110478720547280141752093e-16
    -1.439803219272443632412261074816334132123e-16
    2.350212028533307768492874921311908113061e-17
    -3.746732941148846433878760720748432635161e-18)))

(define fllog-gamma*-0.5-1
  (inline-chebyshev-flpoly-fun
   0.5 1.0
   (0.2232470245502267514562269961799031443467
    -0.03531684112153916140750814833472294824817
    0.005487411267378202333906764957877604178714
    -8.451554782176614393871335697264786415866e-4
    1.298500218537084001825871105239035191564e-4
    -1.998308841854689219433468629427537694764e-5
    3.08782850105024438547188658906886620419e-6
    -4.796899187178370590423796926640840916435e-7
    7.495439908845598614840359144308139505305e-8
    -1.178065986062161318667933939203069189478e-8
    1.861955841376621191032805946118917553841e-9
    -2.958222235520502557525690601358615346189e-10
    4.722447907205211822634083812136054657392e-11
    -7.571661062689880727760130265417874952317e-12
    1.218780337246429967105886562570925924155e-12
    -1.968826721416041316897440063721400317475e-13
    3.19073779524940069943171518028697353828e-14
    -5.186161878624946631195556001152389874128e-15
    8.451950389439240558279437503867061060076e-16
    -1.380770962939255901172479336191563641154e-16
    2.260735093569448234062621057402488693911e-17
    -3.708967120236963219363263440422472504347e-18
    6.092056444503480604548588486478916826137e-19
    -9.76487245037993775187085462755644017716e-20)))

(define fl1/log-gamma*-1-2
  (inline-chebyshev-flpoly-fun
   1.0 2.0
   (36.50597062056126215588490564736211525911
    5.927683391822122158888811838533981599877
    0.009650788682393131891704875205800550373957
    -0.00120710649475178255017764619948027018855
    1.410619617045315346712913021687664484555e-4
    -1.517984671976537123969414399356802738844e-5
    1.44435421162203022065130648183194902607e-6
    -1.064027262344102841746430091209857369845e-7
    1.879186401421778388381964272123433159289e-9
    1.473391904496331023374185562890519473932e-9
    -4.369948342998519096079912854665246731727e-10
    9.210510508827641214148351170566524032963e-11
    -1.712199646937797478609353706953318038582e-11
    2.990869132543335841915461118394156093542e-12
    -5.047400664577971662863737185189271412295e-13
    8.350755216857775467865432627172851478976e-14
    -1.366059433603010448268383337730315334405e-14
    2.221037419308434776098837121150755160272e-15
    -3.600686764465190438408782207305737022582e-16
    5.832082189818439409518779959118483253737e-17
    -9.449174424506190183663094045730721977152e-18
    1.532470886758388082381681800602860079897e-18
    -2.487138516367126427805003399834904796455e-19
    3.940842424570115838317594275099373892591e-20)))

(define fl1/log-gamma*-2-4
  (inline-chebyshev-flpoly-fun
   2.0 4.0
   (72.27341593501407029642510433071460858598
    11.95573007283500690914152180765156818838
    0.006992137331526481971437504059264083079009
    -0.00107877846401048356026389280067628473633
    1.62742826333213238666973870690703457622e-4
    -2.40187085981416004569544073199963582597e-5
    3.467976952336221036859056714426501511846e-6
    -4.895388175383124980258188381696873000961e-7
    6.744955638892661633615712384350525739235e-8
    -9.043446245347883814445477858946601732138e-9
    1.173619393265204870365608485056813005031e-9
    -1.460217152769501813537958654553389987781e-10
    1.710574031528932124096493101439627221767e-11
    -1.814250069164556831968201359893185081786e-12
    1.560892971682010378193451188790027860494e-13
    -5.679762658719801268487423020064768725596e-15
    -1.839836903400198120260369392891332080713e-15
    6.831310724619179474524971424697094551236e-16
    -1.640142975228999674434840856607207232641e-16
    3.392262151898819367384851841967624983936e-17
    -6.505700958294911374591615649606315721645e-18
    1.192630621181478385762407208548995285274e-18
    -2.12125087778177007676223620904324517334e-19
    3.595323730692637841301424139571998290229e-20)))

(define fl1/log-gamma*-4-10
  (inline-chebyshev-flpoly-fun
   4.0 10.0
   (168.125457679189135676626679311199999606
    35.97212291737135665895648341886794681073
    0.006157831501154863768804183964429165127881
    -0.001352346339639808378147885271328503108725
    2.953070811212860909760770516921710079399e-4
    -6.412510812958434138856194918131868626785e-5
    1.384806025264877472672055798373834842752e-5
    -2.974333636639397446167390635127688008179e-6
    6.354156399917970209232788792527870000852e-7
    -1.350250996912693417567156450713501725708e-7
    2.854122843118287364043948193884760327148e-8
    -6.001177707678526147824413228795185502815e-9
    1.255161222642027932776288014225055128028e-9
    -2.611215830981972229357003692789224383773e-10
    5.402968278836591690582562285965732759363e-11
    -1.111774629406032018095023351694421920511e-11
    2.274691014327679984497167126967693232339e-12
    -4.626465557210765158269238044267157513973e-13
    9.351133221739359544507419118346699831002e-14
    -1.877551095922510866491754008510997033006e-14
    3.74284362811961310792762001084337825101e-15
    -7.402441015893025472128173741947141779703e-16
    1.449453899686926342727005746878966189478e-16
    -2.714887109637897623516246683000022934856e-17)))

(define fl1/log-gamma*-10-30
  (inline-chebyshev-flpoly-fun
   10.0 30.0
   (480.0461300506585568873842483695310314919
    119.9876625509278913192844022577840565835
    0.003296894895230223262855409083093493233087
    -8.802869183928848235125896897525093369741e-4
    2.348464225443076939184180241913311247648e-4
    -6.260158787289646595346126193661328430106e-5
    1.667360836092136579374480358823738599525e-5
    -4.437290254225500037668433525581692977172e-6
    1.17991634521653473045791766353574589902e-6
    -3.134951816411294811365685195606047134004e-7
    8.322578870244024982944883264340191900356e-8
    -2.207666520116669306150902868432873600182e-8
    5.851384141940527295996453648463956954519e-9
    -1.549652756392209988330470934152247514037e-9
    4.100736310049375539072498236459060508469e-10
    -1.084281249273355012380232253285598839785e-10
    2.864676888661920695441075401313512588688e-11
    -7.562472701001577103846326454564804329489e-12
    1.994836318120975112445032660758992682198e-12
    -5.257825926875845996301973162479291817389e-13
    1.384692795707496534253288410315070200777e-13
    -3.642797303894955853289557195879395704606e-14
    9.536381884107765825300057235260054658493e-15
    -2.344165462477794757054739966193620450896e-15)))

(: fllog-gamma* (Float -> Float))
(define (fllog-gamma* x)
  (cond [(x . fl<= . 0.0)  (if (fl= x 0.0) +inf.0 +nan.0)]
        [(x . fl< . 1.0)
         (cond [(x . fl< . 0.125)  (fllog-gamma*-taylor-0 x)]
               [(x . fl< . 0.25)  (fllog-gamma*-0.125-0.25 x)]
               [(x . fl< . 0.5)  (fllog-gamma*-0.25-0.5 x)]
               [else  (fllog-gamma*-0.5-1 x)])]
        [(x . fl< . 30.0)
         (cond [(x . fl< . 2.0)  (fl/ 1.0 (fl1/log-gamma*-1-2 x))]
               [(x . fl< . 4.0)  (fl/ 1.0 (fl1/log-gamma*-2-4 x))]
               [(x . fl< . 10.0)  (fl/ 1.0 (fl1/log-gamma*-4-10 x))]
               [else  (fl/ 1.0 (fl1/log-gamma*-10-30 x))])]
        [(x . fl< . 100.0)
         (fl/ ((make-flpolyfun (#i1/12 #i-1/360 #i1/1260 #i-1/1680 #i1/1188))
               (fl/ 1.0 (fl* x x)))
              x)]
        [(x . < . 2000.0)
         (fl/ ((make-flpolyfun (#i1/12 #i-1/360 #i1/1260 #i-1/1680))
               (fl/ 1.0 (fl* x x)))
              x)]
        [(x . < . 4000.0)
         (fl/ ((make-flpolyfun (#i1/12 #i-1/360 #i1/1260))
               (fl/ 1.0 (fl* x x)))
              x)]
        [(x . fl< . 1e9)
         (fl/ (fl+ #i1/12 (fl/ (fl/ #i-1/360 x) x)) x)]
        [else
         (fl/ #i1/12 x)]))

(: flgamma* (Float -> Float))
(define (flgamma* x)
  (cond [(x . fl<= . 0.0)  (if (fl= x 0.0) +inf.0 +nan.0)]
        [(x . fl< . 1e-17)
         ;; Using Gamma(x) ~ 1/x near 0
         (fl/ (flexp x) (fl* (fl* (flsqrt x) sqrt2pi) (flexpt x x)))]
        [(x . fl< . 0.125)
         ;; Using log-gamma* drops bits in this region
         (fl/ (fl* (fl* (flgamma x) (flsqrt x)) (flexp x))
              (fl* sqrt2pi (flexpt x x)))]
        [else
         (flexp (fllog-gamma* x))]))
